<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">Knee_torque_command</span>, <span class="var type1" id="S3T1U4">Ankle_torque_command</span>, <span class="var type1" id="S4T1U5">deltaL</span>, <span class="var type1" id="S5T1U6">hip_pos</span>, <span class="var type1" id="S6T1U7">Esys</span>, <span class="var type1" id="S7T1U8">Esys_integrate_out</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line">        <span class="var type1" id="S8T1U9">U_S_KNEE</span>, <span class="var type1" id="S9T1U10">U_S_ANKLE</span>, <span class="var type1" id="S10T1U11">COPFX</span>, <span class="var type1" id="S11T1U12">U_LIN_DAMP_A</span>, <span class="var type1" id="S12T1U13">U_STOP_K</span>, <span class="var type1" id="S13T1U14">U_STOP_A</span>, <span class="var type1" id="S14T1U15">U_PBC_K</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line">        <span class="var type1" id="S15T1U16">U_PBC_A</span>, <span class="var type1" id="S16T1U17">knee_des_out</span>,<span class="var type1" id="S17T1U18">ankle_des_out</span>, <span class="var type1" id="S18T1U19">foot_contact</span>, <span class="var type1" id="S19T1U20">stance</span>, <span class="var type1" id="S20T1U21">swing</span>,<span class="var type1" id="S21T1U22">phase_var_out</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line">        <span class="var type1" id="S22T1U23">IMU_LIVE_OUT</span>,<span class="var type1" id="S23T1U24">StanceGain</span>,<span class="var type1" id="S24T1U25">SwingGain</span>,<span class="var type1" id="S25T1U26">knee_joint_vel</span>,<span class="var type1" id="S26T1U27">ankle_joint_vel</span>,<span class="var type1" id="S27T1U28">hip_vel</span>,<span class="var type1" id="S28T1U29">PushOffOut</span>]<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line">= SLIP_KPBC(<span class="var type1" id="S29T1U32">IMU_pitch</span>, <span class="var type1" id="S30T1U33">Knee_joint_position</span>, <span class="var type1" id="S31T1U34">Ankle_joint_position</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line">            <span class="var type1" id="S32T1U35">time_in</span>, <span class="var type1" id="S33T1U36">dt</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line">            <span class="var type1" id="S34T1U37">Load_cell_x_force</span>, <span class="var type1" id="S35T1U38">Load_cell_y_force</span>, <span class="var type1" id="S36T1U39">Load_cell_z_force</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line">            <span class="var type1" id="S37T1U40">Load_cell_x_moment</span>, <span class="var type1" id="S38T1U41">Load_cell_y_moment</span>, <span class="var type1" id="S39T1U42">Load_cell_z_moment</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line">            <span class="var type1" id="S40T1U43">kp_knee</span>, <span class="var type1" id="S41T1U44">kd_knee</span>, <span class="var type1" id="S42T1U45">kp_ankle</span>, <span class="var type1" id="S43T1U46">kd_ankle</span>, <span class="var type1" id="S44T1U47">ankle_des_in</span>, <span class="var type1" id="S45T1U48">knee_des_in</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line">            <span class="var type1" id="S46T1U49">vel_filter_coeff</span>, <span class="var type1" id="S47T1U50">KPBC_filter_coeff</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line">            <span class="var type1" id="S48T1U51">SLIP_ON</span>, <span class="var type1" id="S49T1U52">lt</span>, <span class="var type1" id="S50T1U53">k</span>, <span class="var type1" id="S51T1U54">d</span>, <span class="var type1" id="S52T1U55">L0</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line">            <span class="var type1" id="S53T1U56">KPBC_ON</span>, <span class="var type1" id="S54T1U57">KPBC_max_torque_rate</span> , <span class="var type1" id="S55T1U58">pbc_gain_knee</span>, <span class="var type1" id="S56T1U59">md</span>, <span class="var type1" id="S57T1U60">Eref</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line">            <span class="var type1" id="S58T1U61">knee_stop_low</span>, <span class="var type1" id="S59T1U62">knee_stop_high</span>, <span class="var type1" id="S60T1U63">ankle_stop_low</span>, <span class="var type1" id="S61T1U64">ankle_stop_high</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line">            <span class="var type1" id="S62T1U65">max_torque</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line">            <span class="var type1" id="S63T1U66">v0</span>, <span class="var type1" id="S64T1U67">Fric_Comp</span>, <span class="var type1" id="S65T1U68">F_thresh</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line">            <span class="var type1" id="S66T1U69">Command_State</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line">            <span class="var type1" id="S67T1U70">KPBC_max_torque</span>, <span class="var type1" id="S68T1U71">Joint_Bio_Sat</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%Inputs in addition to sensors:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">% Knee_joint_position, Ankle_joint_position are in degrees, in a</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% "biomechanics frame"</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">% t, dt, t_out are in seconds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line">    <span class="comment">%% Persistent Variable Definitions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">%Persistent variables used to store data between iterations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S69T1U73">hip_pos_prev</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line">           <span class="var type1" id="S70T1U74">knee_pos_prev</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line">           <span class="var type1" id="S71T1U75">ankle_pos_prev</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line">           <span class="var type1" id="S72T1U76">knee_vel_prev</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line">           <span class="var type1" id="S73T1U77">ankle_vel_prev</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">           <span class="var type1" id="S74T1U78">hip_vel_prev</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line">           <span class="var type1" id="S75T1U79">Esys_integrate</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">           <span class="var type1" id="S76T1U80">t_switched_phase</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">           <span class="var type1" id="S77T2U81">Stance</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">           <span class="var type1" id="S78T2U82">Swing</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">           <span class="var type1" id="S79T1U83">ForceCount</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">           <span class="var type1" id="S80T1U84">Hip_Pos_Max</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">           <span class="var type1" id="S81T1U85">Hip_Pos_Min</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">           <span class="var type1" id="S82T2U86">IMU_LIVE</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">           <span class="var type1" id="S83T2U87">PushOff</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">           <span class="var type1" id="S84T1U88">u_pbc_knee_prev</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">           <span class="var type1" id="S85T1U89">u_pbc_ankle_prev</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line">           <span class="var type1" id="S86T1U90">COP_prev</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line">       <span class="comment">%t_switched_swing<span class="keyword">...</span><span class="comment"> %implement swing setpoint switching hold?</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U86">isempty(<span class="var type0" id="S70T0U95">knee_pos_prev</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U87"><span class="var type1 sgl" id="S69T1U98">hip_pos_prev</span> = <span class="var type1 sgl" id="S29T1U99">IMU_pitch</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U90"><span class="var type1 sgl" id="S70T1U102">knee_pos_prev</span> = <span class="mxinfo  sgl" id="T1:U92">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U93"><span class="var type1 sgl" id="S71T1U106">ankle_pos_prev</span> = <span class="mxinfo  sgl" id="T1:U95">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U96"><span class="var type1 sgl" id="S72T1U110">knee_vel_prev</span> = <span class="mxinfo  sgl" id="T1:U98">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U99"><span class="var type1 sgl" id="S73T1U114">ankle_vel_prev</span> = <span class="mxinfo  sgl" id="T1:U101">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U102"><span class="var type1 sgl" id="S74T1U118">hip_vel_prev</span> = <span class="mxinfo  sgl" id="T1:U104">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">        <span class="mxinfo " id="T1:U105"><span class="var type1" id="S88T1U122">IMU_pitch_prev</span> = <span class="mxinfo " id="T1:U107">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">        <span class="mxinfo " id="T1:U108"><span class="var type1" id="S75T1U126">Esys_integrate</span>  = <span class="mxinfo " id="T1:U110">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U111"><span class="var type1 sgl" id="S84T1U130">u_pbc_knee_prev</span> = <span class="mxinfo  sgl" id="T1:U113">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U114"><span class="var type1 sgl" id="S85T1U134">u_pbc_ankle_prev</span> = <span class="mxinfo  sgl" id="T1:U116">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U117"><span class="var type1 sgl" id="S76T1U138">t_switched_phase</span> = <span class="var type1 sgl" id="S32T1U139">time_in</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">        <span class="comment">%t_switched_swing = time_in;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">        <span class="mxinfo " id="T2:U120"><span class="var type1" id="S77T2U142">Stance</span> = <span class="mxinfo " id="T2:U122">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">        <span class="mxinfo " id="T2:U123"><span class="var type1" id="S78T2U147">Swing</span> = <span class="mxinfo " id="T2:U125">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U126"><span class="var type1 sgl" id="S79T1U152">ForceCount</span> = <span class="mxinfo  sgl" id="T1:U128">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line">        <span class="mxinfo " id="T1:U129"><span class="var type1" id="S91T1U156">Edis</span> = <span class="mxinfo " id="T1:U131">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line">        <span class="mxinfo " id="T1:U132"><span class="var type1" id="S80T1U160">Hip_Pos_Max</span>  = <span class="mxinfo " id="T1:U134">23</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line">        <span class="mxinfo " id="T1:U135"><span class="var type1" id="S81T1U164">Hip_Pos_Min</span> = <span class="mxinfo " id="T1:U137">-<span class="mxinfo " id="T1:U138">20</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">        <span class="mxinfo " id="T2:U139"><span class="var type1" id="S82T2U169">IMU_LIVE</span> = <span class="mxinfo " id="T2:U141">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line">        <span class="mxinfo " id="T2:U142"><span class="var type1" id="S83T2U174">PushOff</span> = <span class="mxinfo " id="T2:U144">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U145"><span class="var type1 sgl" id="S86T1U179">COP_prev</span> = <span class="mxinfo  sgl" id="T1:U147">-<span class="mxinfo " id="T1:U148">0.0508</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">    <span class="comment">%% Initialization and Hard Coded Values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">    <span class="comment">%params = [Ms,Mf,Isz,Ifz,lt,ls,lc,la,rs,rfy,rfx,COPfx,g];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">    <span class="mxinfo " id="T1:U149"><span class="var type1" id="S92T1U184">Ms</span> = <span class="mxinfo " id="T1:U151">single(6.991429/2.205)</span></span>; <span class="comment">% converted lb to kg</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">    <span class="mxinfo " id="T1:U152"><span class="var type1" id="S94T1U192">Mf</span> = <span class="mxinfo " id="T1:U154">single(1.643130/2.205)</span></span>; <span class="comment">% converted lb to kg</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    <span class="mxinfo " id="T1:U155"><span class="var type1" id="S95T1U200">Isz</span> = <span class="mxinfo " id="T1:U157">single(0.02592934)</span></span>; <span class="comment">%kg*m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    <span class="mxinfo " id="T1:U158"><span class="var type1" id="S96T1U206">Ifz</span> = <span class="mxinfo " id="T1:U160">single(0.0024078341)</span></span>; <span class="comment">%kg*m^2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    <span class="comment">%lt = single(0.3733); %meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="mxinfo " id="T1:U161"><span class="var type1" id="S97T1U212">ls</span> = <span class="mxinfo " id="T1:U163">single(0.3733)</span></span>; <span class="comment">%meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="mxinfo " id="T1:U164"><span class="var type1" id="S98T1U218">rs</span> = <span class="mxinfo " id="T1:U166">single(0.1705526434)</span></span>; <span class="comment">%meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="mxinfo " id="T1:U167"><span class="var type1" id="S99T1U224">la</span> = <span class="mxinfo " id="T1:U169">single(0.0628)</span></span>; <span class="comment">%meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="mxinfo " id="T1:U170"><span class="var type1" id="S100T1U230">rfx</span> = <span class="mxinfo " id="T1:U172">single(0.027510613)</span></span>; <span class="comment">%meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">    <span class="mxinfo " id="T1:U173"><span class="var type1" id="S101T1U236">rfy</span> = <span class="mxinfo " id="T1:U175">single(0.0335)</span></span>; <span class="comment">%meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="mxinfo " id="T1:U176"><span class="var type1" id="S102T1U242">lc</span> = <span class="mxinfo " id="T1:U178">single(2.00914e-5)</span></span>; <span class="comment">%meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">    <span class="mxinfo " id="T1:U179"><span class="var type1" id="S103T1U248">g</span> = <span class="mxinfo " id="T1:U181">9.81</span></span>; <span class="comment">%meters/s^2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">      </span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo " id="T1:U182"><span class="var type1" id="S10T1U252">COPFX</span> = <span class="mxinfo " id="T1:U184">single(<span class="mxinfo " id="T3:U185">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U186"><span class="var type1 sgl" id="S11T1U258">U_LIN_DAMP_A</span> = <span class="mxinfo  sgl" id="T1:U188">single(<span class="mxinfo " id="T3:U189">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U190"><span class="var type1 sgl" id="S8T1U264">U_S_KNEE</span> = <span class="mxinfo  sgl" id="T1:U192">single(<span class="mxinfo " id="T3:U193">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U194"><span class="var type1 sgl" id="S9T1U270">U_S_ANKLE</span> = <span class="mxinfo  sgl" id="T1:U196">single(<span class="mxinfo " id="T3:U197">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U198"><span class="var type1 sgl" id="S14T1U276">U_PBC_K</span> = <span class="mxinfo  sgl" id="T1:U200">single(<span class="mxinfo " id="T3:U201">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U202"><span class="var type1 sgl" id="S15T1U282">U_PBC_A</span> = <span class="mxinfo  sgl" id="T1:U204">single(<span class="mxinfo " id="T3:U205">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">    <span class="comment">% Position/velocity hard limits</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">    <span class="mxinfo " id="T1:U206"><span class="var type1" id="S104T1U288">ANKLE_POS_MIN_LIM</span>  = <span class="mxinfo " id="T1:U208">-<span class="mxinfo " id="T1:U209">35</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">    <span class="mxinfo " id="T1:U210"><span class="var type1" id="S105T1U293">ANKLE_POS_MAX_LIM</span> = <span class="mxinfo " id="T1:U212">35</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">    <span class="mxinfo " id="T1:U213"><span class="var type1" id="S106T1U297">ANKLE_VEL_MIN_LIM</span> = <span class="mxinfo " id="T1:U215">-<span class="mxinfo " id="T1:U216">200</span></span></span>; <span class="comment">%deg/s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">    <span class="mxinfo " id="T1:U217"><span class="var type1" id="S107T1U302">ANKLE_VEL_MAX_LIM</span> = <span class="mxinfo " id="T1:U219">200</span></span>; <span class="comment">%deg/s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">    <span class="mxinfo " id="T1:U220"><span class="var type1" id="S108T1U306">KNEE_POS_MIN_LIM</span> = <span class="mxinfo " id="T1:U222">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">    <span class="mxinfo " id="T1:U223"><span class="var type1" id="S109T1U310">KNEE_POS_MAX_LIM</span> = <span class="mxinfo " id="T1:U225">105</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">    <span class="mxinfo " id="T1:U226"><span class="var type1" id="S110T1U314">KNEE_VEL_MIN_LIM</span> = <span class="mxinfo " id="T1:U228">-<span class="mxinfo " id="T1:U229">400</span></span></span>; <span class="comment">%deg/s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">    <span class="mxinfo " id="T1:U230"><span class="var type1" id="S111T1U319">KNEE_VEL_MAX_LIM</span> = <span class="mxinfo " id="T1:U232">400</span></span>; <span class="comment">%deg/s</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">    <span class="comment">%Winters Data Arrays</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">    <span class="mxinfo " id="T4:U233"><span class="var type1" id="S112T4U323">a_knee</span>=<span class="mxinfo " id="T4:U235">[-21.9472500000000,4.24525000000000,21.6720000000000,0;20.9295000000000,-6.97650000000000,7.71900000000000,0;15.9362500000000,-0.998250000000000,18.6640000000000,25.8830000000000;-59.8412500000000,13.6422500000000,64.8630000000000,0;-19.4405000000000,-1.40250000000000,38.4100000000000,-47.2960000000000;45.1070000000000,-7.15300000000000,0.456000000000000,0;1.42525000000000,0.0657500000000000,2.21000000000000,3.24500000000000]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">    <span class="mxinfo " id="T5:U236"><span class="var type1" id="S113T5U370">a_ankle</span>=<span class="mxinfo " id="T5:U238">[5.50050000000000,-0.880500000000000,-4.60000000000000,0;-8.98500000000000,3.77020000000000,5.26600000000000,4.65120000000000;0.812500000000000,-0.475000000000000,7.74100000000000,2.81250000000000;-2.19975000000000,0.320750000000000,9.62000000000000,0;-14.7575000000000,0.878500000000001,-0.745000000000000,-24.2440000000000;23.0932000000000,-3.91420000000000,-19.9240000000000,0;-29.8020000000000,9.93400000000000,-0.0560000000000000,0;0.703500000000000,-0.234500000000000,-0.525000000000000,0;-2.60850000000000,0.869500000000000,1.21400000000000,0;-0.729000000000000,0.0190000000000000,0.580000000000000,-1.34400000000000]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">    <span class="mxinfo " id="T6:U239"><span class="var type1" id="S114T6U441">knee_ind</span>=<span class="mxinfo " id="T6:U241">[1 139 400 530 720 848 976 1001]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">    <span class="mxinfo " id="T7:U242"><span class="var type1" id="S115T7U454">ankle_ind</span>=<span class="mxinfo " id="T7:U244">[1 61 205 330 440 550 653 846 898 977 1001]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">    <span class="comment">%% State Calculations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">    <span class="comment">%Assign joint positions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U245"><span class="var type1 sgl" id="S5T1U470">hip_pos</span> = <span class="var type1 sgl" id="S29T1U471">IMU_pitch</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">    <span class="mxinfo " id="T1:U248"><span class="var type1" id="S116T1U474">knee_pos</span> =  <span class="var type1 sgl" id="S30T1U475">Knee_joint_position</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">    <span class="mxinfo " id="T1:U251"><span class="var type1" id="S117T1U478">ankle_pos</span> = <span class="var type1 sgl" id="S31T1U479">Ankle_joint_position</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">    <span class="comment">%Calculate joint velocities usindg exponential smoothing filter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">    <span class="comment">%https://en.wikipedia.org/wiki/Exponential_smoothing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U254"><span class="var type1" id="S27T1U482">hip_vel</span> = <span class="mxinfo  sgl" id="T1:U256"><span class="mxinfo  sgl" id="T1:U257">(<span class="mxinfo  sgl" id="T1:U258">1-<span class="var type1 sgl" id="S46T1U488">vel_filter_coeff</span></span>)*<span class="var type1" id="S74T1U489">hip_vel_prev</span></span> + <span class="mxinfo  sgl" id="T1:U261"><span class="mxinfo  sgl" id="T1:U262"><span class="var type1 sgl" id="S46T1U492">vel_filter_coeff</span>*(<span class="mxinfo  sgl" id="T1:U264"><span class="var type1" id="S5T1U495">hip_pos</span>-<span class="var type1" id="S69T1U496">hip_pos_prev</span></span>)</span>/<span class="var type1 sgl" id="S33T1U497">dt</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U268"><span class="var type1" id="S118T1U500">knee_vel</span> = <span class="mxinfo  sgl" id="T1:U270"><span class="mxinfo  sgl" id="T1:U271">(<span class="mxinfo  sgl" id="T1:U272">1-<span class="var type1 sgl" id="S46T1U506">vel_filter_coeff</span></span>)*<span class="var type1" id="S72T1U507">knee_vel_prev</span></span> + <span class="mxinfo  sgl" id="T1:U275"><span class="mxinfo  sgl" id="T1:U276"><span class="var type1 sgl" id="S46T1U510">vel_filter_coeff</span>*(<span class="mxinfo  sgl" id="T1:U278"><span class="var type1" id="S116T1U513">knee_pos</span>-<span class="var type1" id="S70T1U514">knee_pos_prev</span></span>)</span>/<span class="var type1 sgl" id="S33T1U515">dt</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U282"><span class="var type1" id="S119T1U518">ankle_vel</span> = <span class="mxinfo  sgl" id="T1:U284"><span class="mxinfo  sgl" id="T1:U285">(<span class="mxinfo  sgl" id="T1:U286">1-<span class="var type1 sgl" id="S46T1U524">vel_filter_coeff</span></span>)*<span class="var type1" id="S73T1U525">ankle_vel_prev</span></span> + <span class="mxinfo  sgl" id="T1:U289"><span class="mxinfo  sgl" id="T1:U290"><span class="var type1 sgl" id="S46T1U528">vel_filter_coeff</span>*(<span class="mxinfo  sgl" id="T1:U292"><span class="var type1" id="S117T1U531">ankle_pos</span>-<span class="var type1" id="S71T1U532">ankle_pos_prev</span></span>)</span>/<span class="var type1 sgl" id="S33T1U533">dt</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    <span class="comment">%% Determine foot contact</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U296"><span class="mxinfo  dbl sgl" id="T1:U297">norm(<span class="mxinfo  sgl" id="T8:U298">[<span class="var type1 sgl" id="S34T1U541">Load_cell_x_force</span>, <span class="var type1 sgl" id="S35T1U542">Load_cell_y_force</span>, <span class="var type1 sgl" id="S36T1U543">Load_cell_z_force</span>]</span>,2)</span> &gt; <span class="var type1 sgl" id="S65T1U545">F_thresh</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U303"><span class="var type1" id="S79T1U548">ForceCount</span> = <span class="mxinfo  sgl" id="T1:U305"><span class="var type1" id="S79T1U550">ForceCount</span>+1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T2:U307"><span class="var type1 sgl" id="S79T1U555">ForceCount</span> &gt; <span class="mxinfo  sgl" id="T1:U309">2</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">            <span class="mxinfo " id="T2:U310"><span class="var type1" id="S121T2U559">FootContact</span> = <span class="mxinfo " id="T2:U312">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">            <span class="mxinfo " id="T2:U313"><span class="var type1" id="S121T2U565">FootContact</span> = <span class="mxinfo " id="T2:U315">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">        <span class="mxinfo " id="T2:U316"><span class="var type1" id="S121T2U571">FootContact</span> = <span class="mxinfo " id="T2:U318">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U319"><span class="var type1 sgl" id="S79T1U576">ForceCount</span> = <span class="mxinfo  sgl" id="T1:U321">0</span></span>;   </span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">             </span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U322"><span class="var type1 sgl" id="S23T1U580">StanceGain</span> = <span class="mxinfo  sgl" id="T1:U324">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U325"><span class="var type1 sgl" id="S24T1U584">SwingGain</span> = <span class="mxinfo  sgl" id="T1:U327">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo " id="T1:U328"><span class="var type1" id="S122T1U588">t_hold</span> = <span class="mxinfo " id="T1:U330">0.3</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    <span class="comment">%Human Leg as a Robot states</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">    <span class="mxinfo " id="T9:U331"><span class="var type1" id="S123T9U592">x</span> = <span class="mxinfo " id="T9:U333">zeros(4,1)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U334"><span class="mxinfo  sgl" id="T1:U335"><span class="var type1 sgl" id="S123T9U600">x</span>(<span class="mxinfo " id="T10:U337">1</span>)</span> =  <span class="var type1" id="S116T1U602">knee_pos</span></span>; <span class="comment">%MAKE SURE TO MANAGE BIOMECHANICS VS RIGHT-HAND-RULE AXIS ORIENTATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U339"><span class="mxinfo  sgl" id="T1:U340"><span class="var type1 sgl" id="S123T9U606">x</span>(<span class="mxinfo " id="T10:U342">2</span>)</span> =  <span class="var type1" id="S117T1U608">ankle_pos</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U344"><span class="mxinfo  sgl" id="T1:U345"><span class="var type1 sgl" id="S123T9U612">x</span>(<span class="mxinfo " id="T10:U347">3</span>)</span> =  <span class="var type1 sgl" id="S118T1U614">knee_vel</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U349"><span class="mxinfo  sgl" id="T1:U350"><span class="var type1 sgl" id="S123T9U618">x</span>(<span class="mxinfo " id="T10:U352">4</span>)</span> =  <span class="var type1 sgl" id="S119T1U620">ankle_vel</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">    <span class="comment">%Notes:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">    <span class="comment">% Knee axis treated as origin.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">    <span class="comment">% Orientation of knee and ankle rotation is biomechanical</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">    <span class="comment">%variables:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">    <span class="comment">% x - 4x1 array [knee pos, ankle pos, knee vel, ankle vel]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">    <span class="comment">% lt -thigh length </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">    <span class="comment">% ls -shank length</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">    <span class="comment">% lfx, lfy - foot CoM x,y</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">    <span class="comment">% lc - load cell y dist from ankle axis</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">    <span class="comment">% la - ankle axis y dist to bottom of foot</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">    <span class="comment">% COPfx - COP distance along foot from ankle axis projection, to be</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">    <span class="comment">%   computed from load cell</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">    <span class="comment">% Ms - shank mass</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">    <span class="comment">% Mf - foot mass</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">    <span class="comment">% COPfx calc</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">    <span class="mxinfo " id="T1:U354"><span class="var type1" id="S125T1U623">COP_lim_up</span> = <span class="mxinfo " id="T1:U356">single(0.06)</span></span>;  <span class="comment">%from pilot walking trials</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">    <span class="mxinfo " id="T1:U357"><span class="var type1" id="S126T1U629">COP_lim_down</span> = <span class="mxinfo " id="T1:U359">single(-0.0508)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">    <span class="mxinfo " id="T11:U360"><span class="var type1" id="S127T11U636">n</span> = <span class="mxinfo " id="T11:U362">[0,0,1]'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">    <span class="mxinfo " id="T11:U363"><span class="var type1" id="S128T11U645">MA</span> = <span class="mxinfo " id="T11:U365"><span class="mxinfo " id="T8:U366">[<span class="var type1 sgl" id="S37T1U649">Load_cell_x_moment</span>, <span class="var type1 sgl" id="S38T1U650">Load_cell_y_moment</span>, <span class="var type1 sgl" id="S39T1U651">Load_cell_z_moment</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">    <span class="mxinfo  sgl" id="T11:U370"><span class="var type1 sgl" id="S129T11U654">F</span> = <span class="mxinfo " id="T11:U372"><span class="mxinfo " id="T8:U373">[<span class="var type1 sgl" id="S34T1U658">Load_cell_x_force</span>, <span class="var type1 sgl" id="S35T1U659">Load_cell_y_force</span>, <span class="var type1 sgl" id="S36T1U660">Load_cell_z_force</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">    <span class="mxinfo " id="T12:U377"><span class="var type1" id="S130T12U663">WC</span> = <span class="mxinfo " id="T12:U379">[<span class="var type1" id="S129T11U666">F</span>;<span class="var type1" id="S128T11U668">MA</span>]</span></span>;   </span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">    <span class="mxinfo " id="T11:U382"><span class="var type1" id="S131T11U671">OA</span> = <span class="mxinfo " id="T11:U384"><span class="var type1" id="S99T1U673">la</span>*<span class="var type1" id="S127T11U674">n</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">    <span class="mxinfo  sgl" id="T11:U387"><span class="var type1" id="S132T11U677">M0</span> = (<span class="mxinfo  sgl" id="T11:U389"><span class="mxinfo  sgl" id="T11:U390">cross(<span class="mxinfo " id="T11:U391">-<span class="var type1" id="S131T11U683">OA</span></span>,<span class="var type1" id="S129T11U684">F</span>)</span>+<span class="var type1" id="S128T11U685">MA</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">    <span class="mxinfo  sgl" id="T11:U395"><span class="var type1" id="S134T11U688">OC</span> = <span class="mxinfo  sgl" id="T11:U397"><span class="mxinfo  sgl" id="T11:U398">cross(<span class="var type1" id="S127T11U692">n</span>,<span class="var type1 sgl" id="S132T11U693">M0</span>)</span>/<span class="mxinfo  sgl" id="T1:U401">dot(<span class="var type1 sgl" id="S129T11U696">F</span>,<span class="var type1" id="S127T11U697">n</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U404"><span class="var type1 sgl" id="S136T1U700">COPfx</span> = <span class="mxinfo  sgl" id="T1:U406"><span class="var type1 sgl" id="S134T11U702">OC</span>(<span class="mxinfo " id="T10:U408">1</span>)</span></span>;        </span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U409">~<span class="var type1" id="S121T2U707">FootContact</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">        <span class="comment">%(-2,8) inches</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U411"><span class="var type1 sgl" id="S136T1U710">COPfx</span> = <span class="var type1 sgl" id="S126T1U711">COP_lim_down</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U414"><span class="var type1 sgl" id="S86T1U714">COP_prev</span> = <span class="var type1 sgl" id="S126T1U715">COP_lim_down</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">        <span class="comment">%only allow the COP to progress forwards</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T2:U417"><span class="var type1" id="S136T1U720">COPfx</span>&lt;<span class="var type1 sgl" id="S86T1U721">COP_prev</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U420"><span class="var type1 sgl" id="S136T1U724">COPfx</span> = <span class="var type1 sgl" id="S86T1U725">COP_prev</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U423"><span class="var type1 sgl" id="S86T1U729">COP_prev</span> = <span class="var type1" id="S136T1U730">COPfx</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">    <span class="mxinfo " id="T1:U426"><span class="var type1" id="S136T1U733">COPfx</span> = <span class="mxinfo  sgl" id="T1:U428"><span class="fcn" id="F516N6:B735">Saturate</span>(<span class="var type1 sgl" id="S136T1U736">COPfx</span>,<span class="var type1" id="S126T1U737">COP_lim_down</span>,<span class="var type1" id="S125T1U738">COP_lim_up</span>)</span></span>; <span class="comment">%meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">    <span class="mxinfo " id="T1:U432"><span class="var type1" id="S10T1U741">COPFX</span> = <span class="var type1" id="S136T1U742">COPfx</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">    <span class="mxinfo " id="T13:U435"><span class="var type1" id="S138T13U745">params</span> = <span class="mxinfo " id="T13:U437">[<span class="var type1" id="S92T1U748">Ms</span>,<span class="var type1" id="S94T1U749">Mf</span>,<span class="var type1" id="S95T1U750">Isz</span>,<span class="var type1" id="S96T1U751">Ifz</span>,<span class="var type1 sgl" id="S49T1U752">lt</span>,<span class="var type1 sgl" id="S97T1U753">ls</span>,<span class="var type1" id="S102T1U754">lc</span>,<span class="var type1 sgl" id="S99T1U755">la</span>,<span class="var type1" id="S98T1U756">rs</span>,<span class="var type1" id="S101T1U757">rfy</span>,<span class="var type1" id="S100T1U758">rfx</span>,<span class="var type1" id="S136T1U759">COPfx</span>,<span class="var type1" id="S103T1U760">g</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line"><span class="comment">%     M = M_func(x,params);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"><span class="comment">%     C = C_func(x,params);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"><span class="comment">%     G = G_func(x,params);    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">    <span class="mxinfo " id="T1:U451"><span class="var type1" id="S139T1U763">L</span> = <span class="mxinfo  dbl sgl" id="T1:U453"><span class="fcn" id="F579N3:B765">L_func</span>(<span class="var type1" id="S123T9U766">x</span>,<span class="var type1" id="S138T13U767">params</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">    <span class="mxinfo  sgl" id="T14:U456"><span class="var type1" id="S141T14U770">J_L</span> = <span class="mxinfo  dbl sgl" id="T14:U458"><span class="fcn" id="F580N2:B772">J_L_func</span>(<span class="var type1" id="S123T9U773">x</span>,<span class="var type1" id="S138T13U774">params</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line">    <span class="comment">%J_dot_L = J_dot_L_func(x,params);    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line"><span class="comment">%     Theta = Theta_func(x,params);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line"><span class="comment">%     J_Theta = J_Theta_func(x,params);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"><span class="comment">%     J_dot_Theta = J_dot_Theta_func(x,params);   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="comment">%     J_z = [J_L;J_Theta];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line"><span class="comment">%     J_z_dot = [J_dot_L;J_dot_Theta];      </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"><span class="comment">%     J_C = J_C_func(x,params);   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">    <span class="mxinfo " id="T15:U461"><span class="var type1" id="S143T15U777">qdot</span> = <span class="mxinfo " id="T15:U463"><span class="var type1 sgl" id="S123T9U779">x</span>(3:4)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U465"><span class="var type1" id="S4T1U785">deltaL</span> = <span class="mxinfo  sgl" id="T1:U467"><span class="var type1" id="S139T1U787">L</span> - <span class="var type1 sgl" id="S52T1U788">L0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">    <span class="mxinfo " id="T1:U470"><span class="var type1" id="S144T1U791">Ldot</span> = <span class="mxinfo  sgl" id="T1:U472"><span class="var type1 sgl" id="S141T14U793">J_L</span>*<span class="var type1" id="S143T15U794">qdot</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U475"><span class="var type1 sgl" id="S56T1U798">md</span>&lt;<span class="mxinfo  sgl" id="T1:U477">10</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line">       <span class="mxinfo  sgl" id="T1:U478"><span class="var type1 sgl" id="S56T1U802">md</span> = <span class="mxinfo  sgl" id="T1:U480">10</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo " id="T2:U481"><span class="var type1 sgl" id="S56T1U806">md</span>&gt;<span class="mxinfo  sgl" id="T1:U483">10000</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U484"><span class="var type1 sgl" id="S56T1U810">md</span> = <span class="mxinfo  sgl" id="T1:U486">10000</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line">    <span class="comment">%M_z = diag([md,md]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line">    <span class="comment">%Calculate system energy</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line">    <span class="mxinfo " id="T1:U487"><span class="var type1" id="S145T1U814">Espring</span> = <span class="mxinfo  sgl" id="T1:U489"><span class="mxinfo  sgl" id="T1:U490">1/2*<span class="var type1 sgl" id="S50T1U820">k</span></span>*<span class="mxinfo  sgl" id="T1:U492">(<span class="mxinfo  sgl" id="T1:U493"><span class="var type1" id="S139T1U824">L</span>-<span class="var type1 sgl" id="S52T1U825">L0</span></span>)^2</span></span></span>; <span class="comment">%virtual spring potential energy</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line">    <span class="mxinfo " id="T1:U496"><span class="var type1" id="S146T1U829">KE</span> = <span class="mxinfo  sgl" id="T1:U498"><span class="mxinfo  sgl" id="T1:U499">1/2*<span class="var type1 sgl" id="S56T1U835">md</span></span>*<span class="mxinfo  sgl" id="T1:U501">(<span class="var type1" id="S144T1U838">Ldot</span>)^2</span></span></span>;     <span class="comment">%virtual mass kinetic energy</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U503"><span class="var type1" id="S6T1U842">Esys</span> = <span class="mxinfo  sgl" id="T1:U505"><span class="var type1" id="S145T1U844">Espring</span> + <span class="var type1" id="S146T1U845">KE</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line">    <span class="comment">%Phase Variable </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line">    <span class="comment">%s_a=clamp(1+(1-s_m)/(q_h_0-q_h_m)*(hip-q_h_0),0,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line">    <span class="mxinfo " id="T1:U508"><span class="var type1" id="S21T1U848">phase_var_out</span> =  <span class="mxinfo  sgl" id="T1:U510">0.6 + <span class="mxinfo  sgl" id="T1:U511"><span class="mxinfo  sgl" id="T1:U512">0.4*(<span class="mxinfo  sgl" id="T1:U513"><span class="var type1" id="S5T1U856">hip_pos</span>-<span class="var type1" id="S81T1U857">Hip_Pos_Min</span></span>)</span>/(<span class="mxinfo " id="T1:U516"><span class="var type1" id="S80T1U860">Hip_Pos_Max</span>-<span class="var type1" id="S81T1U861">Hip_Pos_Min</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line">    <span class="mxinfo " id="T1:U519"><span class="var type1" id="S21T1U864">phase_var_out</span> = <span class="mxinfo  sgl" id="T1:U521"><span class="fcn" id="F638N7:B866">clamp</span>(<span class="var type1" id="S21T1U867">phase_var_out</span>,<span class="mxinfo " id="T1:U523">0.6</span>,<span class="mxinfo " id="T1:U524">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line">    <span class="comment">%IMU State check</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line">    <span class="mxinfo " id="T2:U525"><span class="var type1" id="S82T2U872">IMU_LIVE</span> = <span class="mxinfo " id="T2:U527"><span class="mxinfo  dbl sgl" id="T1:U528"><span class="message warning" id="M1F1C">abs(<span class="mxinfo  sgl" id="T1:U529"><span class="var type1" id="S69T1U877">hip_pos_prev</span>-<span class="var type1" id="S5T1U878">hip_pos</span></span>)</span></span>&lt;<span class="mxinfo  sgl" id="T1:U532">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line">    <span class="comment">%% Phase State management, set autodetection or command stance/swing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U533"><span class="mxinfo  sgl" id="T16:U534">int8(<span class="var type1 sgl" id="S66T1U885">Command_State</span>)</span> == <span class="mxinfo " id="T16:U536">int8(<span class="mxinfo " id="T3:U537">0</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line">        <span class="comment">%Determine stance vs swing, only allow phase state switching every t_hold seconds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S77T2U892">Stance</span> &amp;&amp; <span class="mxinfo " id="T2:U539">~<span class="var type1" id="S121T2U894">FootContact</span></span> <span class="comment">%The state needs to be switched</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T2:U541"><span class="var type1 sgl" id="S122T1U898">t_hold</span> &lt; (<span class="mxinfo  sgl" id="T1:U543"><span class="var type1 sgl" id="S32T1U901">time_in</span> - <span class="var type1" id="S76T1U902">t_switched_phase</span></span>)</span> <span class="comment">%Check the last time we switched, if its too fast, wait</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line">               <span class="comment">%Switch to SWING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line">               <span class="mxinfo  sgl" id="T1:U546"><span class="var type1 sgl" id="S76T1U905">t_switched_phase</span> = <span class="var type1 sgl" id="S32T1U906">time_in</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line">               <span class="mxinfo " id="T2:U549"><span class="var type1" id="S78T2U909">Swing</span> = <span class="mxinfo " id="T2:U551">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line">               <span class="mxinfo " id="T2:U552"><span class="var type1" id="S77T2U914">Stance</span> = <span class="mxinfo " id="T2:U554">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line">               <span class="comment">%reset the energy intergration variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line">               <span class="comment">%Esys_integrate = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line">               <span class="comment">%Edis = 0; </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line">               <span class="mxinfo  sgl" id="T1:U555"><span class="var type1 sgl" id="S84T1U919">u_pbc_knee_prev</span> = <span class="mxinfo  sgl" id="T1:U557">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line">               <span class="mxinfo  sgl" id="T1:U558"><span class="var type1 sgl" id="S85T1U923">u_pbc_ankle_prev</span> = <span class="mxinfo  sgl" id="T1:U560">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line">        <span class="keyword">elseif</span> <span class="var type1" id="S78T2U927">Swing</span> &amp;&amp; <span class="var type1" id="S121T2U928">FootContact</span> <span class="comment">%ditto, but for the other case</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T2:U563"><span class="var type1 sgl" id="S122T1U932">t_hold</span> &lt; (<span class="mxinfo  sgl" id="T1:U565"><span class="var type1 sgl" id="S32T1U935">time_in</span> - <span class="var type1" id="S76T1U936">t_switched_phase</span></span>)</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line">                <span class="comment">%Switch to STANCE</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U568"><span class="var type1 sgl" id="S76T1U939">t_switched_phase</span> = <span class="var type1 sgl" id="S32T1U940">time_in</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line">                <span class="mxinfo " id="T2:U571"><span class="var type1" id="S78T2U943">Swing</span> = <span class="mxinfo " id="T2:U573">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line">                <span class="mxinfo " id="T2:U574"><span class="var type1" id="S77T2U948">Stance</span> = <span class="mxinfo " id="T2:U576">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line">        <span class="comment">%Manage torque smoothing when switching phases</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S77T2U953">Stance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U578"><span class="var type1" id="S150T1U956">t_norm</span> = <span class="mxinfo  sgl" id="T1:U580">(<span class="mxinfo  sgl" id="T1:U581"><span class="var type1 sgl" id="S32T1U960">time_in</span> - <span class="var type1" id="S76T1U961">t_switched_phase</span></span>)/(<span class="var type1" id="S122T1U964">t_hold</span>*0.8)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,252" id="srcline252">252</a></span><span class="line">            <span class="mxinfo " id="T1:U585"><span class="var type1" id="S23T1U968">StanceGain</span> = <span class="mxinfo  sgl" id="T1:U587">min(<span class="var type1 sgl" id="S150T1U971">t_norm</span>,<span class="mxinfo " id="T1:U589">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,253" id="srcline253">253</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U590"><span class="var type1" id="S24T1U975">SwingGain</span> = <span class="mxinfo  sgl" id="T1:U592">1-<span class="var type1" id="S23T1U978">StanceGain</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,254" id="srcline254">254</a></span><span class="line">        <span class="keyword">elseif</span> <span class="var type1" id="S78T2U980">Swing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,255" id="srcline255">255</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U595"><span class="var type1" id="S150T1U983">t_norm</span> = <span class="mxinfo  sgl" id="T1:U597">(<span class="mxinfo  sgl" id="T1:U598"><span class="var type1 sgl" id="S32T1U987">time_in</span> - <span class="var type1" id="S76T1U988">t_switched_phase</span></span>)/(<span class="var type1" id="S122T1U991">t_hold</span>*0.8)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,256" id="srcline256">256</a></span><span class="line">            <span class="mxinfo " id="T1:U602"><span class="var type1" id="S24T1U995">SwingGain</span> = <span class="mxinfo  sgl" id="T1:U604">min(<span class="var type1 sgl" id="S150T1U998">t_norm</span>,<span class="mxinfo " id="T1:U606">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,257" id="srcline257">257</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U607"><span class="var type1" id="S23T1U1002">StanceGain</span> = <span class="mxinfo  sgl" id="T1:U609">1-<span class="var type1" id="S24T1U1005">SwingGain</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,258" id="srcline258">258</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,259" id="srcline259">259</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo " id="T2:U611"><span class="mxinfo  sgl" id="T16:U612">int8(<span class="var type1 sgl" id="S66T1U1010">Command_State</span>)</span> == <span class="mxinfo " id="T16:U614">int8(<span class="mxinfo " id="T3:U615">1</span>)</span></span> <span class="comment">%Stance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,260" id="srcline260">260</a></span><span class="line">        <span class="mxinfo " id="T2:U616"><span class="var type1" id="S77T2U1016">Stance</span> = <span class="mxinfo " id="T2:U618">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,261" id="srcline261">261</a></span><span class="line">        <span class="mxinfo " id="T2:U619"><span class="var type1" id="S78T2U1021">Swing</span> = <span class="mxinfo " id="T2:U621">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,262" id="srcline262">262</a></span><span class="line">        <span class="mxinfo " id="T1:U622"><span class="var type1" id="S80T1U1026">Hip_Pos_Max</span> = <span class="mxinfo " id="T1:U624">23</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,263" id="srcline263">263</a></span><span class="line">        <span class="mxinfo " id="T1:U625"><span class="var type1" id="S81T1U1030">Hip_Pos_Min</span> = <span class="mxinfo " id="T1:U627">- <span class="mxinfo " id="T1:U628">20</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,264" id="srcline264">264</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U629"><span class="var type1 sgl" id="S23T1U1035">StanceGain</span> = <span class="mxinfo  sgl" id="T1:U631">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,265" id="srcline265">265</a></span><span class="line">        <span class="mxinfo " id="T1:U632"><span class="var type1" id="S24T1U1039">SwingGain</span> = <span class="mxinfo " id="T1:U634">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,266" id="srcline266">266</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo " id="T2:U635"><span class="mxinfo  sgl" id="T16:U636">int8(<span class="var type1 sgl" id="S66T1U1045">Command_State</span>)</span> == <span class="mxinfo " id="T16:U638">int8(<span class="mxinfo " id="T3:U639">2</span>)</span></span> <span class="comment">%Swing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,267" id="srcline267">267</a></span><span class="line">        <span class="mxinfo " id="T2:U640"><span class="var type1" id="S77T2U1051">Stance</span> = <span class="mxinfo " id="T2:U642">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,268" id="srcline268">268</a></span><span class="line">        <span class="mxinfo " id="T2:U643"><span class="var type1" id="S78T2U1056">Swing</span> = <span class="mxinfo " id="T2:U645">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,269" id="srcline269">269</a></span><span class="line">        <span class="mxinfo " id="T1:U646"><span class="var type1" id="S80T1U1061">Hip_Pos_Max</span> = <span class="mxinfo " id="T1:U648">23</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,270" id="srcline270">270</a></span><span class="line">        <span class="mxinfo " id="T1:U649"><span class="var type1" id="S81T1U1065">Hip_Pos_Min</span> = <span class="mxinfo " id="T1:U651">- <span class="mxinfo " id="T1:U652">20</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,271" id="srcline271">271</a></span><span class="line">        <span class="mxinfo " id="T1:U653"><span class="var type1" id="S23T1U1070">StanceGain</span> = <span class="mxinfo " id="T1:U655">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,272" id="srcline272">272</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U656"><span class="var type1 sgl" id="S24T1U1074">SwingGain</span> = <span class="mxinfo  sgl" id="T1:U658">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,273" id="srcline273">273</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,274" id="srcline274">274</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,275" id="srcline275">275</a></span><span class="line">    <span class="comment">%% Torque computation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,276" id="srcline276">276</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1 sgl" id="S48T1U1078">SLIP_ON</span>       </span></span>
<span class="srcline"><span class="lineno"><a href="1,277" id="srcline277">277</a></span><span class="line">        <span class="mxinfo " id="T1:U660"><span class="var type1" id="S152T1U1081">Knee_torque_command_stance</span> = <span class="mxinfo " id="T1:U662">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line">        <span class="mxinfo " id="T1:U663"><span class="var type1" id="S153T1U1085">Ankle_torque_command_stance</span> = <span class="mxinfo " id="T1:U665">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line">        <span class="comment">%% Stance                </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line">        <span class="comment">%Virtual spring</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line">        <span class="comment">%MAKE SURE TO MANAGE BIOMECHANICS VS RIGHT-HAND-RULE AXIS ORIENTATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line">        <span class="mxinfo  sgl" id="T15:U666"><span class="var type1" id="S154T15U1089">u_lin_spring</span> = <span class="mxinfo  sgl" id="T15:U668"><span class="mxinfo  sgl" id="T1:U669"><span class="mxinfo  sgl" id="T1:U670">-<span class="var type1 sgl" id="S50T1U1093">k</span></span>.*(<span class="var type1 sgl" id="S4T1U1095">deltaL</span>)</span>.*<span class="mxinfo " id="T15:U673"><span class="var type1 sgl" id="S141T14U1097">J_L</span>'</span></span></span>;     </span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line">        <span class="mxinfo  sgl" id="T15:U675"><span class="var type1" id="S155T15U1100">u_lin_damp</span> = <span class="mxinfo  sgl" id="T15:U677"><span class="mxinfo  sgl" id="T1:U678"><span class="mxinfo  sgl" id="T1:U679">-<span class="var type1 sgl" id="S51T1U1104">d</span></span>.*(<span class="var type1" id="S144T1U1106">Ldot</span>)</span>.*<span class="mxinfo " id="T15:U682"><span class="var type1 sgl" id="S141T14U1108">J_L</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line">        <span class="mxinfo " id="T1:U684"><span class="var type1" id="S156T1U1111">U_LIN_DAMP_K</span> = <span class="mxinfo " id="T1:U686"><span class="var type1 sgl" id="S155T15U1113">u_lin_damp</span>(<span class="mxinfo " id="T10:U688">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U689"><span class="var type1 sgl" id="S11T1U1117">U_LIN_DAMP_A</span> = <span class="mxinfo " id="T1:U691"><span class="var type1 sgl" id="S155T15U1119">u_lin_damp</span>(<span class="mxinfo " id="T10:U693">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line">        <span class="mxinfo " id="T1:U694"><span class="var type1" id="S157T1U1123">U_LIN_SPRING_K</span> = <span class="mxinfo " id="T1:U696"><span class="var type1 sgl" id="S154T15U1125">u_lin_spring</span>(<span class="mxinfo " id="T10:U698">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line">        <span class="mxinfo " id="T1:U699"><span class="var type1" id="S158T1U1129">U_LIN_SPRING_A</span> = <span class="mxinfo " id="T1:U701"><span class="var type1 sgl" id="S154T15U1131">u_lin_spring</span>(<span class="mxinfo " id="T10:U703">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U704"><span class="var type1" id="S152T1U1135">Knee_torque_command_stance</span>  = <span class="mxinfo  sgl" id="T1:U706"><span class="mxinfo " id="T1:U707"><span class="var type1" id="S152T1U1138">Knee_torque_command_stance</span> + <span class="var type1" id="S156T1U1139">U_LIN_DAMP_K</span></span> + <span class="var type1" id="S157T1U1140">U_LIN_SPRING_K</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U711"><span class="var type1" id="S153T1U1143">Ankle_torque_command_stance</span> = <span class="mxinfo  sgl" id="T1:U713"><span class="mxinfo " id="T1:U714"><span class="var type1" id="S153T1U1146">Ankle_torque_command_stance</span> + <span class="var type1" id="S11T1U1147">U_LIN_DAMP_A</span></span> + <span class="var type1" id="S158T1U1148">U_LIN_SPRING_A</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1 sgl" id="S53T1U1151">KPBC_ON</span> <span class="comment">%Also use energy tracking controller   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line">            <span class="mxinfo " id="T1:U719"><span class="var type1" id="S159T1U1154">kappa</span> = <span class="var type1 sgl" id="S55T1U1155">pbc_gain_knee</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line">            <span class="mxinfo  sgl" id="T14:U722"><span class="var type1" id="S160T14U1158">u_r</span>  = <span class="mxinfo  sgl" id="T14:U724"><span class="mxinfo  sgl" id="T1:U725"><span class="mxinfo  sgl" id="T1:U726"><span class="var type1" id="S159T1U1162">kappa</span>*(<span class="mxinfo  sgl" id="T1:U728"><span class="var type1 sgl" id="S6T1U1165">Esys</span> - <span class="var type1 sgl" id="S57T1U1166">Eref</span></span>)</span>*<span class="var type1" id="S144T1U1167">Ldot</span></span>*<span class="var type1 sgl" id="S141T14U1168">J_L</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line">            <span class="comment">%MAKE SURE TO MANAGE BIOMECHANICS VS RIGHT-HAND-RULE AXIS ORIENTATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,297" id="srcline297">297</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U733"><span class="var type1 sgl" id="S14T1U1171">U_PBC_K</span> = <span class="mxinfo  sgl" id="T1:U735"><span class="var type1 sgl" id="S160T14U1173">u_r</span>(<span class="mxinfo " id="T10:U737">1</span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,298" id="srcline298">298</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U738"><span class="var type1 sgl" id="S15T1U1177">U_PBC_A</span> = <span class="mxinfo  sgl" id="T1:U740"><span class="var type1 sgl" id="S160T14U1179">u_r</span>(<span class="mxinfo " id="T10:U742">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,299" id="srcline299">299</a></span><span class="line">                         </span></span>
<span class="srcline"><span class="lineno"><a href="1,300" id="srcline300">300</a></span><span class="line">            <span class="comment">%Moving average filter and saturation laws on value and rate of torque       </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,301" id="srcline301">301</a></span><span class="line">            <span class="comment">%Absolute saturation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,302" id="srcline302">302</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T2:U743"><span class="var type1 sgl" id="S67T1U1184">KPBC_max_torque</span>&gt;<span class="mxinfo  sgl" id="T1:U745">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,303" id="srcline303">303</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U746"><span class="var type1" id="S14T1U1188">U_PBC_K</span> = <span class="mxinfo  sgl" id="T1:U748"><span class="fcn" id="F516N6:B1190">Saturate</span>(<span class="var type1" id="S14T1U1191">U_PBC_K</span>,<span class="mxinfo  sgl" id="T1:U750">-<span class="var type1 sgl" id="S67T1U1193">KPBC_max_torque</span></span>,<span class="var type1 sgl" id="S67T1U1194">KPBC_max_torque</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,304" id="srcline304">304</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U753"><span class="var type1" id="S15T1U1197">U_PBC_A</span> = <span class="mxinfo  sgl" id="T1:U755"><span class="fcn" id="F516N6:B1199">Saturate</span>(<span class="var type1" id="S15T1U1200">U_PBC_A</span>,<span class="mxinfo  sgl" id="T1:U757">-<span class="var type1 sgl" id="S67T1U1202">KPBC_max_torque</span></span>,<span class="var type1 sgl" id="S67T1U1203">KPBC_max_torque</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,305" id="srcline305">305</a></span><span class="line">            <span class="keyword">end</span>           </span></span>
<span class="srcline"><span class="lineno"><a href="1,306" id="srcline306">306</a></span><span class="line">            <span class="comment">%Rate saturation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,307" id="srcline307">307</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T2:U760"><span class="var type1 sgl" id="S54T1U1207">KPBC_max_torque_rate</span>&gt;<span class="mxinfo  sgl" id="T1:U762">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,308" id="srcline308">308</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U763"><span class="var type1" id="S161T1U1211">dk</span> = <span class="mxinfo  sgl" id="T1:U765">(<span class="mxinfo  sgl" id="T1:U766"><span class="var type1 sgl" id="S14T1U1215">U_PBC_K</span>-<span class="var type1" id="S84T1U1216">u_pbc_knee_prev</span></span>)/<span class="var type1 sgl" id="S33T1U1217">dt</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,309" id="srcline309">309</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U770"><span class="var type1" id="S162T1U1220">da</span> = <span class="mxinfo  sgl" id="T1:U772">(<span class="mxinfo  sgl" id="T1:U773"><span class="var type1 sgl" id="S15T1U1224">U_PBC_A</span>-<span class="var type1" id="S85T1U1225">u_pbc_ankle_prev</span></span>)/<span class="var type1 sgl" id="S33T1U1226">dt</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,310" id="srcline310">310</a></span><span class="line">                <span class="mxinfo " id="T1:U777"><span class="var type1" id="S161T1U1229">dk</span> = <span class="mxinfo  sgl" id="T1:U779"><span class="fcn" id="F516N6:B1231">Saturate</span>(<span class="var type1 sgl" id="S161T1U1232">dk</span>, <span class="mxinfo  sgl" id="T1:U781">-<span class="var type1 sgl" id="S54T1U1234">KPBC_max_torque_rate</span></span>, <span class="var type1 sgl" id="S54T1U1235">KPBC_max_torque_rate</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,311" id="srcline311">311</a></span><span class="line">                <span class="mxinfo " id="T1:U784"><span class="var type1" id="S162T1U1238">da</span> = <span class="mxinfo  sgl" id="T1:U786"><span class="fcn" id="F516N6:B1240">Saturate</span>(<span class="var type1 sgl" id="S162T1U1241">da</span>, <span class="mxinfo  sgl" id="T1:U788">-<span class="var type1 sgl" id="S54T1U1243">KPBC_max_torque_rate</span></span>, <span class="var type1 sgl" id="S54T1U1244">KPBC_max_torque_rate</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,312" id="srcline312">312</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U791"><span class="var type1" id="S14T1U1247">U_PBC_K</span> = <span class="mxinfo  sgl" id="T1:U793"><span class="mxinfo  sgl" id="T1:U794"><span class="var type1" id="S161T1U1250">dk</span>*<span class="var type1 sgl" id="S33T1U1251">dt</span></span>+<span class="var type1" id="S84T1U1252">u_pbc_knee_prev</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,313" id="srcline313">313</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U798"><span class="var type1" id="S15T1U1255">U_PBC_A</span> = <span class="mxinfo  sgl" id="T1:U800"><span class="mxinfo  sgl" id="T1:U801"><span class="var type1" id="S162T1U1258">da</span>*<span class="var type1 sgl" id="S33T1U1259">dt</span></span>+<span class="var type1" id="S85T1U1260">u_pbc_ankle_prev</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,314" id="srcline314">314</a></span><span class="line">            <span class="keyword">end</span>           </span></span>
<span class="srcline"><span class="lineno"><a href="1,315" id="srcline315">315</a></span><span class="line">            <span class="comment">%Exponential smoothing of torque</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,316" id="srcline316">316</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U805"><span class="var type1" id="S14T1U1263">U_PBC_K</span> = <span class="mxinfo  sgl" id="T1:U807"><span class="mxinfo  sgl" id="T1:U808">(<span class="mxinfo  sgl" id="T1:U809">1-<span class="var type1 sgl" id="S47T1U1269">KPBC_filter_coeff</span></span>)*<span class="var type1" id="S84T1U1270">u_pbc_knee_prev</span></span> + <span class="mxinfo  sgl" id="T1:U812"><span class="var type1 sgl" id="S47T1U1272">KPBC_filter_coeff</span>*<span class="var type1 sgl" id="S14T1U1273">U_PBC_K</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,317" id="srcline317">317</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U815"><span class="var type1" id="S15T1U1276">U_PBC_A</span> = <span class="mxinfo  sgl" id="T1:U817"><span class="mxinfo  sgl" id="T1:U818">(<span class="mxinfo  sgl" id="T1:U819">1-<span class="var type1 sgl" id="S47T1U1282">KPBC_filter_coeff</span></span>)*<span class="var type1" id="S85T1U1283">u_pbc_ankle_prev</span></span> + <span class="mxinfo  sgl" id="T1:U822"><span class="var type1 sgl" id="S47T1U1285">KPBC_filter_coeff</span>*<span class="var type1 sgl" id="S15T1U1286">U_PBC_A</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,318" id="srcline318">318</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,319" id="srcline319">319</a></span><span class="line">            <span class="comment">%Biomemetic power saturation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,320" id="srcline320">320</a></span><span class="line">            <span class="keyword">if</span> <span class="var type1 sgl" id="S68T1U1289">Joint_Bio_Sat</span>               </span></span>
<span class="srcline"><span class="lineno"><a href="1,321" id="srcline321">321</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U826"><span class="var type1" id="S163T1U1292">Pow_Knee</span> = <span class="mxinfo  sgl" id="T1:U828"><span class="var type1 sgl" id="S118T1U1294">knee_vel</span>*<span class="var type1 sgl" id="S14T1U1295">U_PBC_K</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,322" id="srcline322">322</a></span><span class="line">                <span class="mxinfo  sgl" id="T1:U831"><span class="var type1" id="S164T1U1298">Pow_Ankle</span> = <span class="mxinfo  sgl" id="T1:U833"><span class="var type1 sgl" id="S119T1U1300">ankle_vel</span>*<span class="var type1 sgl" id="S15T1U1301">U_PBC_A</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,323" id="srcline323">323</a></span><span class="line">                <span class="keyword">if</span> <span class="mxinfo  sgl" id="T2:U836"><span class="mxinfo  sgl" id="T1:U837">sign(<span class="var type1 sgl" id="S164T1U1307">Pow_Ankle</span>)</span> == <span class="mxinfo  sgl" id="T1:U839">-<span class="mxinfo " id="T1:U840">1</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,324" id="srcline324">324</a></span><span class="line">                    <span class="mxinfo  sgl" id="T1:U841"><span class="var type1 sgl" id="S15T1U1312">U_PBC_A</span> = <span class="mxinfo  sgl" id="T1:U843">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,325" id="srcline325">325</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,326" id="srcline326">326</a></span><span class="line">                <span class="keyword">if</span> <span class="mxinfo  sgl" id="T2:U844"><span class="mxinfo  sgl" id="T1:U845">sign(<span class="var type1 sgl" id="S163T1U1319">Pow_Knee</span>)</span> == <span class="mxinfo  sgl" id="T1:U847">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,327" id="srcline327">327</a></span><span class="line">                    <span class="mxinfo  sgl" id="T1:U848"><span class="var type1 sgl" id="S14T1U1323">U_PBC_K</span> = <span class="mxinfo  sgl" id="T1:U850">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,328" id="srcline328">328</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,329" id="srcline329">329</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,330" id="srcline330">330</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U851"><span class="var type1" id="S152T1U1327">Knee_torque_command_stance</span> = <span class="mxinfo  sgl" id="T1:U853"><span class="mxinfo  sgl" id="T1:U854"><span class="var type1 sgl" id="S152T1U1330">Knee_torque_command_stance</span> + <span class="var type1 sgl" id="S14T1U1331">U_PBC_K</span></span> - <span class="var type1" id="S156T1U1332">U_LIN_DAMP_K</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,331" id="srcline331">331</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U858"><span class="var type1" id="S153T1U1335">Ankle_torque_command_stance</span> = <span class="mxinfo  sgl" id="T1:U860"><span class="mxinfo  sgl" id="T1:U861"><span class="var type1 sgl" id="S153T1U1338">Ankle_torque_command_stance</span> + <span class="var type1 sgl" id="S15T1U1339">U_PBC_A</span></span> - <span class="var type1" id="S11T1U1340">U_LIN_DAMP_A</span></span></span>;          </span></span>
<span class="srcline"><span class="lineno"><a href="1,332" id="srcline332">332</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,333" id="srcline333">333</a></span><span class="line">        <span class="comment">%% Swing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,334" id="srcline334">334</a></span><span class="line">        <span class="mxinfo " id="T1:U865"><span class="var type1" id="S166T1U1343">Knee_torque_command_swing</span>=<span class="mxinfo " id="T1:U867">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,335" id="srcline335">335</a></span><span class="line">        <span class="mxinfo " id="T1:U868"><span class="var type1" id="S167T1U1347">Ankle_torque_command_swing</span>=<span class="mxinfo " id="T1:U870">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,336" id="srcline336">336</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S82T2U1351">IMU_LIVE</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,337" id="srcline337">337</a></span><span class="line">            <span class="comment">%Use hip pos as phase variable to index winters data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,338" id="srcline338">338</a></span><span class="line">            [<span class="var type1 sgl" id="S16T1U1355">knee_des_out</span> ,<span class="mxinfo " id="T1:U873">~</span>,<span class="var type1 sgl" id="S17T1U1357">ankle_des_out</span>,<span class="mxinfo " id="T1:U875">~</span>]=<span class="fcn" id="F723N10:B1360">winterFit</span>(<span class="mxinfo  sgl" id="T1:U876"><span class="var type1" id="S21T1U1362">phase_var_out</span>*1000</span>,<span class="var type1" id="S112T4U1364">a_knee</span>,<span class="var type1" id="S113T5U1365">a_ankle</span>,<span class="var type1" id="S114T6U1366">knee_ind</span>,<span class="var type1" id="S115T7U1367">ankle_ind</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,339" id="srcline339">339</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,340" id="srcline340">340</a></span><span class="line">            <span class="comment">%follow the trjactory via PD controller</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,341" id="srcline341">341</a></span><span class="line">            [<span class="var type1 sgl" id="S166T1U1371">Knee_torque_command_swing</span>,<span class="var type1 sgl" id="S167T1U1372">Ankle_torque_command_swing</span>] = <span class="fcn" id="F724N5:B1374">PDControl</span>(<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,342" id="srcline342">342</a></span><span class="line">            <span class="var type1 sgl" id="S40T1U1375">kp_knee</span>, <span class="var type1 sgl" id="S41T1U1376">kd_knee</span>, <span class="var type1" id="S16T1U1377">knee_des_out</span>, <span class="var type1" id="S116T1U1378">knee_pos</span>, <span class="var type1 sgl" id="S118T1U1379">knee_vel</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,343" id="srcline343">343</a></span><span class="line">            <span class="var type1 sgl" id="S42T1U1380">kp_ankle</span>, <span class="var type1 sgl" id="S43T1U1381">kd_ankle</span>, <span class="var type1" id="S17T1U1382">ankle_des_out</span>, <span class="var type1" id="S117T1U1383">ankle_pos</span>, <span class="var type1 sgl" id="S119T1U1384">ankle_vel</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,344" id="srcline344">344</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="1,345" id="srcline345">345</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,346" id="srcline346">346</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U894"><span class="var type1 sgl" id="S16T1U1388">knee_des_out</span> = <span class="var type1" id="S116T1U1389">knee_pos</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,347" id="srcline347">347</a></span><span class="line">            <span class="mxinfo  sgl" id="T1:U897"><span class="var type1 sgl" id="S17T1U1392">ankle_des_out</span> = <span class="var type1" id="S117T1U1393">ankle_pos</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,348" id="srcline348">348</a></span><span class="line">            [<span class="var type1 sgl" id="S166T1U1397">Knee_torque_command_swing</span>,<span class="var type1 sgl" id="S167T1U1398">Ankle_torque_command_swing</span>] = <span class="fcn" id="F724N5:B1400">PDControl</span>(<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,349" id="srcline349">349</a></span><span class="line">            <span class="var type1 sgl" id="S40T1U1401">kp_knee</span>, <span class="var type1 sgl" id="S41T1U1402">kd_knee</span>, <span class="var type1" id="S16T1U1403">knee_des_out</span>, <span class="var type1" id="S116T1U1404">knee_pos</span>, <span class="var type1 sgl" id="S118T1U1405">knee_vel</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,350" id="srcline350">350</a></span><span class="line">            <span class="var type1 sgl" id="S42T1U1406">kp_ankle</span>, <span class="var type1 sgl" id="S43T1U1407">kd_ankle</span>, <span class="var type1" id="S17T1U1408">ankle_des_out</span>, <span class="var type1" id="S117T1U1409">ankle_pos</span>, <span class="var type1 sgl" id="S119T1U1410">ankle_vel</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,351" id="srcline351">351</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,352" id="srcline352">352</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,353" id="srcline353">353</a></span><span class="line">        <span class="comment">%Smooth between stance and swing torques</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,354" id="srcline354">354</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U912"><span class="var type1" id="S2T1U1413">Knee_torque_command</span> = <span class="mxinfo  sgl" id="T1:U914"><span class="mxinfo  sgl" id="T1:U915"><span class="var type1 sgl" id="S23T1U1416">StanceGain</span>*<span class="var type1 sgl" id="S152T1U1417">Knee_torque_command_stance</span></span> + <span class="mxinfo  sgl" id="T1:U918"><span class="var type1 sgl" id="S24T1U1419">SwingGain</span>*<span class="var type1 sgl" id="S166T1U1420">Knee_torque_command_swing</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,355" id="srcline355">355</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U921"><span class="var type1" id="S3T1U1423">Ankle_torque_command</span> = <span class="mxinfo  sgl" id="T1:U923"><span class="mxinfo  sgl" id="T1:U924"><span class="var type1 sgl" id="S23T1U1426">StanceGain</span>*<span class="var type1 sgl" id="S153T1U1427">Ankle_torque_command_stance</span></span> + <span class="mxinfo  sgl" id="T1:U927"><span class="var type1 sgl" id="S24T1U1429">SwingGain</span>*<span class="var type1 sgl" id="S167T1U1430">Ankle_torque_command_swing</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,356" id="srcline356">356</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,357" id="srcline357">357</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,358" id="srcline358">358</a></span><span class="line">        <span class="mxinfo " id="T2:U930"><span class="var type1" id="S82T2U1434">IMU_LIVE</span> = <span class="mxinfo " id="T2:U932">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,359" id="srcline359">359</a></span><span class="line">        <span class="comment">%Use Setpoint PD control</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,360" id="srcline360">360</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U933"><span class="var type1 sgl" id="S16T1U1439">knee_des_out</span> = <span class="var type1 sgl" id="S45T1U1440">knee_des_in</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,361" id="srcline361">361</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U936"><span class="var type1 sgl" id="S17T1U1443">ankle_des_out</span> = <span class="var type1 sgl" id="S44T1U1444">ankle_des_in</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,362" id="srcline362">362</a></span><span class="line">        [<span class="var type1 sgl" id="S2T1U1448">Knee_torque_command</span>,<span class="var type1 sgl" id="S3T1U1449">Ankle_torque_command</span>] = <span class="fcn" id="F724N5:B1451">PDControl</span>(<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,363" id="srcline363">363</a></span><span class="line">            <span class="var type1 sgl" id="S40T1U1452">kp_knee</span>, <span class="var type1 sgl" id="S41T1U1453">kd_knee</span>, <span class="var type1" id="S16T1U1454">knee_des_out</span>, <span class="var type1" id="S116T1U1455">knee_pos</span>, <span class="var type1 sgl" id="S118T1U1456">knee_vel</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,364" id="srcline364">364</a></span><span class="line">            <span class="var type1 sgl" id="S42T1U1457">kp_ankle</span>, <span class="var type1 sgl" id="S43T1U1458">kd_ankle</span>, <span class="var type1" id="S17T1U1459">ankle_des_out</span>, <span class="var type1" id="S117T1U1460">ankle_pos</span>, <span class="var type1 sgl" id="S119T1U1461">ankle_vel</span>);        </span></span>
<span class="srcline"><span class="lineno"><a href="1,365" id="srcline365">365</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,366" id="srcline366">366</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,367" id="srcline367">367</a></span><span class="line">    <span class="comment">%% Friction Compensation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,368" id="srcline368">368</a></span><span class="line">    <span class="comment">%v0 = 0.01;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,369" id="srcline369">369</a></span><span class="line">    <span class="mxinfo " id="T1:U951"><span class="var type1" id="S170T1U1464">tau0</span> = <span class="mxinfo " id="T1:U953">5</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,370" id="srcline370">370</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1 sgl" id="S64T1U1468">Fric_Comp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,371" id="srcline371">371</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U955"><span class="var type1" id="S2T1U1471">Knee_torque_command</span> = <span class="mxinfo  sgl" id="T1:U957"><span class="fcn" id="F751N8:B1473">friction_compensation</span>(<span class="var type1 sgl" id="S118T1U1474">knee_vel</span>,<span class="var type1 sgl" id="S2T1U1475">Knee_torque_command</span> ,<span class="var type1 sgl" id="S63T1U1476">v0</span>,<span class="var type1" id="S170T1U1477">tau0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,372" id="srcline372">372</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U962"><span class="var type1" id="S3T1U1480">Ankle_torque_command</span> = <span class="mxinfo  sgl" id="T1:U964"><span class="fcn" id="F751N8:B1482">friction_compensation</span>(<span class="var type1 sgl" id="S119T1U1483">ankle_vel</span>,<span class="var type1 sgl" id="S3T1U1484">Ankle_torque_command</span> ,<span class="var type1 sgl" id="S63T1U1485">v0</span>,<span class="var type1" id="S170T1U1486">tau0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,373" id="srcline373">373</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,374" id="srcline374">374</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,375" id="srcline375">375</a></span><span class="line">    <span class="comment">%% Virtual hard stops</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,376" id="srcline376">376</a></span><span class="line">    <span class="mxinfo  sgl" id="T15:U969"><span class="var type1 sgl" id="S172T15U1489">u_stop</span> = <span class="mxinfo  sgl" id="T15:U971">zeros(2,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,377" id="srcline377">377</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U972"><span class="var type1 sgl" id="S58T1U1498">knee_stop_low</span> &lt; <span class="var type1 sgl" id="S59T1U1499">knee_stop_high</span></span> &amp;&amp; <span class="mxinfo " id="T2:U975"><span class="var type1 sgl" id="S60T1U1501">ankle_stop_low</span> &lt; <span class="var type1 sgl" id="S61T1U1502">ankle_stop_high</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,378" id="srcline378">378</a></span><span class="line">        <span class="mxinfo  sgl" id="T14:U978"><span class="var type1 sgl" id="S173T14U1505">knee_limits</span> = <span class="mxinfo " id="T14:U980">[<span class="var type1 sgl" id="S58T1U1508">knee_stop_low</span>, <span class="var type1 sgl" id="S59T1U1509">knee_stop_high</span>]</span></span>;  <span class="comment">%deg, need to make sure its ordered</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,379" id="srcline379">379</a></span><span class="line">        <span class="mxinfo  sgl" id="T14:U983"><span class="var type1 sgl" id="S174T14U1512">ankle_limits</span> = <span class="mxinfo " id="T14:U985">[<span class="var type1 sgl" id="S60T1U1515">ankle_stop_low</span>, <span class="var type1 sgl" id="S61T1U1516">ankle_stop_high</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,380" id="srcline380">380</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,381" id="srcline381">381</a></span><span class="line">        <span class="mxinfo  sgl" id="T14:U988"><span class="var type1 sgl" id="S173T14U1520">knee_limits</span> = <span class="mxinfo  sgl" id="T14:U990">single([<span class="var type1 sgl" id="S108T1U1525">KNEE_POS_MIN_LIM</span>, <span class="var type1 sgl" id="S109T1U1526">KNEE_POS_MAX_LIM</span>])</span></span>;  <span class="comment">%deg, need to make sure its ordered</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,382" id="srcline382">382</a></span><span class="line">        <span class="mxinfo  sgl" id="T14:U993"><span class="var type1 sgl" id="S174T14U1529">ankle_limits</span> = <span class="mxinfo  sgl" id="T14:U995">single([<span class="var type1 sgl" id="S104T1U1534">ANKLE_POS_MIN_LIM</span>, <span class="var type1 sgl" id="S105T1U1535">ANKLE_POS_MAX_LIM</span>])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,383" id="srcline383">383</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,384" id="srcline384">384</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,385" id="srcline385">385</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U998"><span class="var type1" id="S116T1U1539">knee_pos</span> &lt; <span class="mxinfo  sgl" id="T1:U1000"><span class="var type1 sgl" id="S173T14U1541">knee_limits</span>(<span class="mxinfo " id="T1:U1002">1</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,386" id="srcline386">386</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U1003"><span class="mxinfo  sgl" id="T1:U1004"><span class="var type1 sgl" id="S172T15U1546">u_stop</span>(<span class="mxinfo " id="T1:U1006">1</span>)</span> = <span class="mxinfo  sgl" id="T1:U1007"><span class="mxinfo  sgl" id="T1:U1008"><span class="mxinfo  sgl" id="T1:U1009">-<span class="var type1 sgl" id="S40T1U1551">kp_knee</span></span>*(<span class="mxinfo  sgl" id="T1:U1011"><span class="var type1" id="S116T1U1554">knee_pos</span> - <span class="mxinfo  sgl" id="T1:U1013"><span class="var type1 sgl" id="S173T14U1556">knee_limits</span>(<span class="mxinfo " id="T10:U1015">1</span>)</span></span>)</span> - <span class="mxinfo  sgl" id="T1:U1016"><span class="var type1 sgl" id="S41T1U1559">kd_knee</span>*(<span class="var type1 sgl" id="S118T1U1561">knee_vel</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,387" id="srcline387">387</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,388" id="srcline388">388</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U1019"><span class="mxinfo  sgl" id="T1:U1020"><span class="var type1 sgl" id="S173T14U1566">knee_limits</span>(<span class="mxinfo " id="T10:U1022">2</span>)</span> &lt; <span class="var type1" id="S116T1U1568">knee_pos</span></span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,389" id="srcline389">389</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U1024"><span class="mxinfo  sgl" id="T1:U1025"><span class="var type1 sgl" id="S172T15U1572">u_stop</span>(<span class="mxinfo " id="T1:U1027">1</span>)</span> = <span class="mxinfo  sgl" id="T1:U1028"><span class="mxinfo  sgl" id="T1:U1029"><span class="mxinfo  sgl" id="T1:U1030">-<span class="var type1 sgl" id="S40T1U1577">kp_knee</span></span>*(<span class="mxinfo  sgl" id="T1:U1032"><span class="var type1" id="S116T1U1580">knee_pos</span> - <span class="mxinfo  sgl" id="T1:U1034"><span class="var type1 sgl" id="S173T14U1582">knee_limits</span>(<span class="mxinfo " id="T10:U1036">2</span>)</span></span>)</span> - <span class="mxinfo  sgl" id="T1:U1037"><span class="var type1 sgl" id="S41T1U1585">kd_knee</span>*(<span class="var type1 sgl" id="S118T1U1587">knee_vel</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,390" id="srcline390">390</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,391" id="srcline391">391</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U1040"><span class="var type1" id="S117T1U1591">ankle_pos</span> &lt; <span class="mxinfo  sgl" id="T1:U1042"><span class="var type1 sgl" id="S174T14U1593">ankle_limits</span>(<span class="mxinfo " id="T1:U1044">1</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,392" id="srcline392">392</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U1045"><span class="mxinfo  sgl" id="T1:U1046"><span class="var type1 sgl" id="S172T15U1598">u_stop</span>(<span class="mxinfo " id="T1:U1048">2</span>)</span> = <span class="mxinfo  sgl" id="T1:U1049"><span class="mxinfo  sgl" id="T1:U1050"><span class="mxinfo  sgl" id="T1:U1051">-<span class="var type1 sgl" id="S42T1U1603">kp_ankle</span></span>*(<span class="mxinfo  sgl" id="T1:U1053"><span class="var type1" id="S117T1U1606">ankle_pos</span> - <span class="mxinfo  sgl" id="T1:U1055"><span class="var type1 sgl" id="S174T14U1608">ankle_limits</span>(<span class="mxinfo " id="T10:U1057">1</span>)</span></span>)</span> - <span class="mxinfo  sgl" id="T1:U1058"><span class="var type1 sgl" id="S43T1U1611">kd_ankle</span>*(<span class="var type1 sgl" id="S119T1U1613">ankle_vel</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,393" id="srcline393">393</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,394" id="srcline394">394</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U1061"><span class="mxinfo  sgl" id="T1:U1062"><span class="var type1 sgl" id="S174T14U1618">ankle_limits</span>(<span class="mxinfo " id="T10:U1064">2</span>)</span> &lt; <span class="var type1" id="S117T1U1620">ankle_pos</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,395" id="srcline395">395</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U1066"><span class="mxinfo  sgl" id="T1:U1067"><span class="var type1 sgl" id="S172T15U1624">u_stop</span>(<span class="mxinfo " id="T1:U1069">2</span>)</span> = <span class="mxinfo  sgl" id="T1:U1070"><span class="mxinfo  sgl" id="T1:U1071"><span class="mxinfo  sgl" id="T1:U1072">-<span class="var type1 sgl" id="S42T1U1629">kp_ankle</span></span>*(<span class="mxinfo  sgl" id="T1:U1074"><span class="var type1" id="S117T1U1632">ankle_pos</span> - <span class="mxinfo  sgl" id="T1:U1076"><span class="var type1 sgl" id="S174T14U1634">ankle_limits</span>(<span class="mxinfo " id="T10:U1078">2</span>)</span></span>)</span> - <span class="mxinfo  sgl" id="T1:U1079"><span class="var type1 sgl" id="S43T1U1637">kd_ankle</span>*(<span class="var type1 sgl" id="S119T1U1639">ankle_vel</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,396" id="srcline396">396</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,397" id="srcline397">397</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1082"><span class="var type1 sgl" id="S12T1U1642">U_STOP_K</span> = <span class="mxinfo " id="T1:U1084"><span class="var type1 sgl" id="S172T15U1644">u_stop</span>(<span class="mxinfo " id="T1:U1086">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,398" id="srcline398">398</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1087"><span class="var type1 sgl" id="S13T1U1648">U_STOP_A</span> = <span class="mxinfo " id="T1:U1089"><span class="var type1 sgl" id="S172T15U1650">u_stop</span>(<span class="mxinfo " id="T1:U1091">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,399" id="srcline399">399</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1092"><span class="var type1" id="S2T1U1654">Knee_torque_command</span> = <span class="mxinfo  sgl" id="T1:U1094"><span class="var type1 sgl" id="S2T1U1656">Knee_torque_command</span> + <span class="mxinfo " id="T1:U1096"><span class="var type1 sgl" id="S172T15U1658">u_stop</span>(<span class="mxinfo " id="T10:U1098">1</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,400" id="srcline400">400</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1099"><span class="var type1" id="S3T1U1662">Ankle_torque_command</span> = <span class="mxinfo  sgl" id="T1:U1101"><span class="var type1 sgl" id="S3T1U1664">Ankle_torque_command</span> + <span class="mxinfo " id="T1:U1103"><span class="var type1 sgl" id="S172T15U1666">u_stop</span>(<span class="mxinfo " id="T10:U1105">2</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,401" id="srcline401">401</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,402" id="srcline402">402</a></span><span class="line">    <span class="comment">%% Saturate torque output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,403" id="srcline403">403</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U1106"><span class="var type1 sgl" id="S62T1U1671">max_torque</span>&gt;<span class="mxinfo  sgl" id="T1:U1108">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,404" id="srcline404">404</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U1109"><span class="var type1" id="S2T1U1675">Knee_torque_command</span> = <span class="mxinfo  sgl" id="T1:U1111"><span class="fcn" id="F516N6:B1677">Saturate</span>(<span class="var type1 sgl" id="S2T1U1678">Knee_torque_command</span>,<span class="mxinfo  sgl" id="T1:U1113">-<span class="var type1 sgl" id="S62T1U1680">max_torque</span></span>,<span class="var type1 sgl" id="S62T1U1681">max_torque</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,405" id="srcline405">405</a></span><span class="line">        <span class="mxinfo  sgl" id="T1:U1116"><span class="var type1" id="S3T1U1684">Ankle_torque_command</span> = <span class="mxinfo  sgl" id="T1:U1118"><span class="fcn" id="F516N6:B1686">Saturate</span>(<span class="var type1 sgl" id="S3T1U1687">Ankle_torque_command</span>,<span class="mxinfo  sgl" id="T1:U1120">-<span class="var type1 sgl" id="S62T1U1689">max_torque</span></span>,<span class="var type1 sgl" id="S62T1U1690">max_torque</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,406" id="srcline406">406</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,407" id="srcline407">407</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,408" id="srcline408">408</a></span><span class="line">    <span class="comment">%% Persistent/output variable management</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,409" id="srcline409">409</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1123"><span class="var type1 sgl" id="S7T1U1693">Esys_integrate_out</span> = <span class="var type1 sgl" id="S75T1U1694">Esys_integrate</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,410" id="srcline410">410</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1126"><span class="var type1 sgl" id="S70T1U1697">knee_pos_prev</span> = <span class="var type1" id="S116T1U1698">knee_pos</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,411" id="srcline411">411</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1129"><span class="var type1 sgl" id="S71T1U1701">ankle_pos_prev</span> = <span class="var type1" id="S117T1U1702">ankle_pos</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,412" id="srcline412">412</a></span><span class="line">    <span class="mxinfo " id="T1:U1132"><span class="var type1" id="S72T1U1705">knee_vel_prev</span>=<span class="var type1" id="S118T1U1706">knee_vel</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,413" id="srcline413">413</a></span><span class="line">    <span class="mxinfo " id="T1:U1135"><span class="var type1" id="S73T1U1709">ankle_vel_prev</span>=<span class="var type1" id="S119T1U1710">ankle_vel</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,414" id="srcline414">414</a></span><span class="line">    <span class="mxinfo " id="T1:U1138"><span class="var type1" id="S88T1U1713">IMU_pitch_prev</span>=<span class="var type1" id="S29T1U1714">IMU_pitch</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,415" id="srcline415">415</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1141"><span class="var type1 sgl" id="S74T1U1717">hip_vel_prev</span> = <span class="var type1 sgl" id="S27T1U1718">hip_vel</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,416" id="srcline416">416</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1144"><span class="var type1 sgl" id="S69T1U1721">hip_pos_prev</span> = <span class="var type1" id="S5T1U1722">hip_pos</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,417" id="srcline417">417</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1147"><span class="var type1 sgl" id="S84T1U1725">u_pbc_knee_prev</span> = <span class="var type1 sgl" id="S14T1U1726">U_PBC_K</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,418" id="srcline418">418</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1150"><span class="var type1 sgl" id="S85T1U1729">u_pbc_ankle_prev</span> = <span class="var type1 sgl" id="S15T1U1730">U_PBC_A</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,419" id="srcline419">419</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1153"><span class="var type1 sgl" id="S25T1U1733">knee_joint_vel</span> = <span class="mxinfo " id="T1:U1155">single(<span class="var type1 sgl" id="S118T1U1736">knee_vel</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,420" id="srcline420">420</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1157"><span class="var type1 sgl" id="S26T1U1739">ankle_joint_vel</span> = <span class="mxinfo " id="T1:U1159">single(<span class="var type1 sgl" id="S119T1U1742">ankle_vel</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,421" id="srcline421">421</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1161"><span class="var type1 sgl" id="S18T1U1745">foot_contact</span> = <span class="mxinfo  sgl" id="T1:U1163">single(<span class="var type1" id="S121T2U1748">FootContact</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,422" id="srcline422">422</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1165"><span class="var type1 sgl" id="S19T1U1751">stance</span> = <span class="mxinfo  sgl" id="T1:U1167">single(<span class="var type1" id="S77T2U1754">Stance</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,423" id="srcline423">423</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1169"><span class="var type1 sgl" id="S20T1U1757">swing</span> = <span class="mxinfo  sgl" id="T1:U1171">single(<span class="var type1" id="S78T2U1760">Swing</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,424" id="srcline424">424</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1173"><span class="var type1 sgl" id="S22T1U1763">IMU_LIVE_OUT</span> = <span class="mxinfo  sgl" id="T1:U1175">single(<span class="var type1" id="S82T2U1766">IMU_LIVE</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,425" id="srcline425">425</a></span><span class="line">    <span class="mxinfo  sgl" id="T1:U1177"><span class="var type1 sgl" id="S28T1U1769">PushOffOut</span> = <span class="mxinfo  sgl" id="T1:U1179">single(<span class="var type1" id="S83T2U1772">PushOff</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,426" id="srcline426">426</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,427" id="srcline427">427</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,428" id="srcline428">428</a></span><span class="line"><span class="comment">%% Helper functions</span></span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,429" id="srcline429">429</a></span><span class="line">function [Knee_torque_command,Ankle_torque_command] = PDControl(kp_k, kd_k, q_kstar, q_k, qdot_k, kp_a, kd_a, q_astar, q_a, qdot_a)</span></span>
<span class="srcline"><span class="lineno"><a href="1,430" id="srcline430">430</a></span><span class="line">    <span class="comment">%This control basically assumes that the desired joint angles are static i.e., the desired velocities are all zero.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,431" id="srcline431">431</a></span><span class="line">    Knee_torque_command = kp_k*(q_kstar - q_k) + kd_k*(-qdot_k);</span></span>
<span class="srcline"><span class="lineno"><a href="1,432" id="srcline432">432</a></span><span class="line">    Ankle_torque_command = kp_a*(q_astar - q_a) + kd_a*(-qdot_a);</span></span>
<span class="srcline"><span class="lineno"><a href="1,433" id="srcline433">433</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,434" id="srcline434">434</a></span><span class="line">function y = Saturate(x,L1,L2)</span></span>
<span class="srcline"><span class="lineno"><a href="1,435" id="srcline435">435</a></span><span class="line">    <span class="comment">%Function to prevent the desired joint angles from changing to fast. </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,436" id="srcline436">436</a></span><span class="line">    <span class="comment">%Works via saturation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,437" id="srcline437">437</a></span><span class="line">    y = min(x,max(L1,L2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,438" id="srcline438">438</a></span><span class="line">    y = max(y,min(L1,L2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,439" id="srcline439">439</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,440" id="srcline440">440</a></span><span class="line">function tau_com_w_fric=friction_compensation(v,tau_com,v0,tau0)</span></span>
<span class="srcline"><span class="lineno"><a href="1,441" id="srcline441">441</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,442" id="srcline442">442</a></span><span class="line">f_k_n=-1.7;</span></span>
<span class="srcline"><span class="lineno"><a href="1,443" id="srcline443">443</a></span><span class="line">f_s_n=-2.8;</span></span>
<span class="srcline"><span class="lineno"><a href="1,444" id="srcline444">444</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,445" id="srcline445">445</a></span><span class="line">f_s_p=1.6;</span></span>
<span class="srcline"><span class="lineno"><a href="1,446" id="srcline446">446</a></span><span class="line">f_k_p=0.8;</span></span>
<span class="srcline"><span class="lineno"><a href="1,447" id="srcline447">447</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,448" id="srcline448">448</a></span><span class="line">r_v_p=sat_one(v,0,v0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,449" id="srcline449">449</a></span><span class="line">r_v_n=sat_one(v,-v0,0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,450" id="srcline450">450</a></span><span class="line">r_t_p=sat_one(tau_com,0,tau0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,451" id="srcline451">451</a></span><span class="line">r_t_n=sat_one(tau_com,-tau0,0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,452" id="srcline452">452</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,453" id="srcline453">453</a></span><span class="line">tau_fric=r_v_p*f_k_p+(1-r_v_n)*f_k_n+(1-r_v_p)*r_v_n*(r_t_p*f_s_p+(1-r_t_n)*f_s_n);</span></span>
<span class="srcline"><span class="lineno"><a href="1,454" id="srcline454">454</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,455" id="srcline455">455</a></span><span class="line">tau_com_w_fric=tau_com+tau_fric;</span></span>
<span class="srcline"><span class="lineno"><a href="1,456" id="srcline456">456</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,457" id="srcline457">457</a></span><span class="line">function y=sat_one(x,a,b)</span></span>
<span class="srcline"><span class="lineno"><a href="1,458" id="srcline458">458</a></span><span class="line">if x&lt;a</span></span>
<span class="srcline"><span class="lineno"><a href="1,459" id="srcline459">459</a></span><span class="line">    y=0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,460" id="srcline460">460</a></span><span class="line">elseif x&lt;b</span></span>
<span class="srcline"><span class="lineno"><a href="1,461" id="srcline461">461</a></span><span class="line">    y=(x-a)/(b-a);</span></span>
<span class="srcline"><span class="lineno"><a href="1,462" id="srcline462">462</a></span><span class="line">else</span></span>
<span class="srcline"><span class="lineno"><a href="1,463" id="srcline463">463</a></span><span class="line">    y=1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,464" id="srcline464">464</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,465" id="srcline465">465</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,466" id="srcline466">466</a></span><span class="line">function [knee_r,dknee_r,ankle_r,dankle_r] = winterFit(n,a_knee,a_ankle,knee_ind,ankle_ind)</span></span>
<span class="srcline"><span class="lineno"><a href="1,467" id="srcline467">467</a></span><span class="line">m1=2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,468" id="srcline468">468</a></span><span class="line">m2=6;</span></span>
<span class="srcline"><span class="lineno"><a href="1,469" id="srcline469">469</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,470" id="srcline470">470</a></span><span class="line">c_n_knee=n-knee_ind;</span></span>
<span class="srcline"><span class="lineno"><a href="1,471" id="srcline471">471</a></span><span class="line">j_knee=length(c_n_knee(c_n_knee&gt;=0));</span></span>
<span class="srcline"><span class="lineno"><a href="1,472" id="srcline472">472</a></span><span class="line">x=(n-knee_ind(j_knee))/(knee_ind(j_knee+1)-knee_ind(j_knee));</span></span>
<span class="srcline"><span class="lineno"><a href="1,473" id="srcline473">473</a></span><span class="line">knee_r=a_knee(j_knee,1)*(x-1).^m1+a_knee(j_knee,2)*(x-1).^m2+a_knee(j_knee,4)*(x-1)+a_knee(j_knee,3);</span></span>
<span class="srcline"><span class="lineno"><a href="1,474" id="srcline474">474</a></span><span class="line">dknee_r=(m1*a_knee(j_knee,1)*(x-1).^(m1-1)+m2*a_knee(j_knee,2)*(x-1).^(m2-1)+a_knee(j_knee,4))/(knee_ind(j_knee+1)-knee_ind(j_knee));</span></span>
<span class="srcline"><span class="lineno"><a href="1,475" id="srcline475">475</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,476" id="srcline476">476</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,477" id="srcline477">477</a></span><span class="line">c_n_ankle=n-ankle_ind;</span></span>
<span class="srcline"><span class="lineno"><a href="1,478" id="srcline478">478</a></span><span class="line">j_ankle=length(c_n_ankle(c_n_ankle&gt;=0));</span></span>
<span class="srcline"><span class="lineno"><a href="1,479" id="srcline479">479</a></span><span class="line">x=(n-ankle_ind(j_ankle))/(ankle_ind(j_ankle+1)-ankle_ind(j_ankle));</span></span>
<span class="srcline"><span class="lineno"><a href="1,480" id="srcline480">480</a></span><span class="line">ankle_r=a_ankle(j_ankle,1)*(x-1).^m1+a_ankle(j_ankle,2)*(x-1).^m2+a_ankle(j_ankle,4)*(x-1)+a_ankle(j_ankle,3);</span></span>
<span class="srcline"><span class="lineno"><a href="1,481" id="srcline481">481</a></span><span class="line">dankle_r=(m1*a_ankle(j_ankle,1)*(x-1).^(m1-1)+m2*a_ankle(j_ankle,2)*(x-1).^(m2-1)+a_ankle(j_ankle,4))/(ankle_ind(j_ankle+1)-ankle_ind(j_ankle));</span></span>
<span class="srcline"><span class="lineno"><a href="1,482" id="srcline482">482</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,483" id="srcline483">483</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,484" id="srcline484">484</a></span><span class="line">function y = clamp(x,x1,x2)</span></span>
<span class="srcline"><span class="lineno"><a href="1,485" id="srcline485">485</a></span><span class="line">y=min(x,max(x1,x2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,486" id="srcline486">486</a></span><span class="line">y=max(y,min(x1,x2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,487" id="srcline487">487</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,488" id="srcline488">488</a></span><span class="line"> </span></span>
</pre>
</div>
